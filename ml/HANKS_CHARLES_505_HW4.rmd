---
title: "Homework 4"
author: "Charles Hanks"
date: "02/1/2023"
output: 
  html_document:
    df_print: kable
    fig_width: 11
    fig_height: 8
---

**Directions:**

Please turn in **both** a knitted HTML file *and* your Rmd file on WISE.

Good luck!

# 1. Setup (1pt)

Change the author of this RMD file to be yourself and modify the below code so that you can successfully load the 'wine.rds' data file from your own computer.

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = "/Users/charleshanks/Desktop/MSDS/SPRING_23/ML")
library(tidyverse)
library(caret)
library(naivebayes)
library(tidytext)
wine = read_rds("pinot.rds")
```

# 2. Conditional Probability (3pts)

Calculate $P(Burgundy | Fruit)$

...i.e. the probability that a Pinot comes from Burgundy given it has the word 'fruit' in the description.

```{r}
#doc term matrix: 
df <- wine %>%
unnest_tokens(word, description) %>%
anti_join(stop_words) %>% # get rid of stop words
filter(word != "wine") %>%
filter(word != "pinot") %>%
count(ID, word) %>%
group_by(ID) %>%
mutate(freq = n/sum(n)) %>%
mutate(exists = (n>0)) %>%
ungroup %>%
group_by(word) %>%
mutate(total = sum(n))

num_fruit = df %>% filter(word == "fruit") %>% group_by(id) %>% nrow() 

#3724 wines have fruit in description

total_wine = nrow(wine)
#8380


p_f = num_fruit/total_wine
#.444 probability that there is fruit is description 

#probability that wine is burgundy
p_b = wine %>% filter(province == "Burgundy") %>% count()/total_wine
#.142

#subset with only burgundy wines 
burg_province = wine %>% filter(province == "Burgundy") 

#burgundy wine term matrix
bp_df <- burg_province %>%
unnest_tokens(word, description) %>%
anti_join(stop_words) %>% 
filter(word != "wine") %>%
filter(word != "pinot") %>%
count(id, word)

fruit_burg = bp_df %>% filter(word == "fruit")
#520 burgundy have fruit in the description 
#So P(Fruit | Burgundy)
p_fg = (nrow(fruit_burg))/(nrow(burg_province))
#.439

# P(Burgundy | Fruit) = P(Fruit | Burgundy) * P(Burgundy) / P(Fruit)
answer = round((p_b*p_fg)/(p_f),2)
answer


```

The probability that a Pinot comes from Burgundy given that it has the word "fruit" in the description is .14. 




# 3. Naive Bayes Algorithm (4pts)

1. Train a naive bayes algorithm to classify a wine's province,
2. using 80% of your data,
3. three features engineered from the description
4. and 5-fold cross validation.
5. Report Kappa after using your model to predict provinces in the holdout (test) sample.

```{r}
ds_nb = wine %>% mutate(acidity = as.integer(str_detect(description, "[Aa]cidity")),
                       nose = as.integer(str_detect(description, "[Nn]ose")),
                       palate = as.integer(str_detect(description, "[Pp]alate"))) %>% 
                select(province, acidity,nose, palate )


wine_index <- createDataPartition(ds_nb$province, p = 0.8, list = FALSE)
train <- ds_nb[ wine_index, ]
test <- ds_nb[-wine_index, ]

control <- trainControl(method = "cv", number = 5)

nbm <- train(province ~ .,
             data = train, 
             method = "naive_bayes",
             tuneGrid = expand.grid(usekernel = c(T,F), laplace = T, adjust = T),
             metric = "Kappa",
             trControl = control)

nbm

confusionMatrix(predict(nbm,test), factor(test$province))

nbm$coefnames

features = data.frame(nbm$coefnames) %>% 
  mutate(nbm.coefnames = str_remove(nbm.coefnames, "TRUE")) %>% 
    filter(nbm.coefnames != "ID")

df %>% left_join(select(wine, id, province), by = "id") %>% 
  dplyr::count(province, word) %>% 
  filter(province %in% c("California", "Oregon")) %>% 
  group_by(province) %>% 
    top_n(5,n) %>% 
    arrange(province, desc(n)) %>% 
    mutate(exists = word %in% features$nbm.coefnames)

df %>% left_join(select(wine, id, province), by = "id") %>% 
  dplyr::count(province, word) %>% 
  group_by(province) %>% 
  top_n(5,n) %>% 
  distinct(word)

wino <- df %>%
filter(word %in% features$fit.coefnames | word
%in% c("berry", "notes", "noir", "cranberry")) %>%
pivot_wider(id_cols = id, names_from = word,
values_from = exists, values_fill = list(exists=0)) %>%
right_join(select(wine,id, province, points, price)) %>%
drop_na()

```




# 4. Frequency differences (2pts)

List the three words that most distinguish New York Pinots from all other Pinots.

```{r}
wtxt <- wine %>% 
  unnest_tokens(word, description) %>% 
  anti_join(stop_words) %>% 
  filter(str_detect(string = word, pattern = "[a-z+]")) %>%  # get rid weird non alphas
  filter(str_length(word)>3) %>%  # get rid of strings shorter than 3 characters
  group_by(word) %>% 
  mutate(total=n()) %>% 
  ungroup() %>% 
  filter(!(word %in% c("wine","pinot","drink","noir","vineyard","palate","notes","flavors","bottling"))) 

wtxt = wtxt %>% group_by(province, word) %>% 
  count() %>% # how many times each word is said for each province 
    group_by(province) %>% 
    mutate(proportion = n / sum(n)) %>% 
    pivot_wider(id_cols = word, names_from = province, values_from = proportion) 

#changing NAs to 0
wtxt[is.na(wtxt)] = 0

#creating an average across all provinces of proportion of word occurance
wtxt$avg_prop = rowMeans(wtxt[,-1])

wtxt$ny_diff = wtxt$New_York - wtxt$avg_prop

answer = wtxt %>% arrange(desc(ny_diff)) %>% select(word, ny_diff) %>% top_n(3)
list(answer$word)

```

